  

# 매크로(Macro)란?

Swift 매크로는 컴파일 타임에 코드를 생성하거나 검사할 수 있는 기능으로, 반복적인 코드를 줄이고, 코드의 안전성과 가독성을 높여줍니다. Swift 5.9와 Xcode 15부터 공식적으로 지원되며, 대표적으로 컴파일 타임 코드 생성과 컴파일 타임 검증에 활용됩니돠

  

---

# Swift 매크로의 종류

Swift 매크로는 크게 두 가지로 나뉩니다.

|   |   |   |
|---|---|---|
|**종류**|**사용법 예시**|**설명**|
|Freestanding|`**#매크로이름(...)**`|해시(#)로 시작, 독립적으로 사용|
|Attached|`**@매크로이름**`|어트리뷰트(@)로 시작, 선언에 붙여서 사용|

  

---

  

# 예시

  

**Freestanding Macro 예시**

```Swift
let url = \#URL("https://www.example.com")
```

- URL이 유효하지 않으면 컴파일 타임에 에러 발생
- 이런 매크로 많음
    
    - 내가 쓴것도
    
    ```Swift
    print(\#fileID, #function, \#line, "- 현재 사용자 상태: \(userState ?? "nil리리맘보다 이새꺄 ㅋㅋ")")
    ```
    

**Attached Macro 예시**

```Swift
@Observable
class MyModel { ... }
```

- 클래스에 프로퍼티 감시 기능 등 부가 기능을 자동으로 추가

  

---

  

## **매크로의 역할(Roles)**

Swift 매크로는 다양한 역할을 가질 수 있습니다:

- **@freestanding(expression)**: 값을 반환하는 코드 생성
- **@freestanding(declaration)**: 선언(함수, 변수, 타입 등) 생성
- **@attached(peer)**: 선언 옆에 새로운 선언 추가
- **@attached(accessor)**: 프로퍼티에 접근자(get/set) 추가
- **@attached(memberAttribute)**: 타입/익스텐션 내 선언에 속성 추가
- **@attached(member)**: 타입/익스텐션 내에 새로운 선언 추가
- **@attached(conformance)**: 프로토콜 준수 추가

  

---

  

**Builder 패턴 매크로**

```Swift
@Buildable struct Person { ... }
let person = PersonBuilder(age: 42).build()
```

  

**Codable 자동화 매크로**

```Swift
@CodingKeys
struct User: Codable { ... }
```

  

- 유용할거같으니까 `Codable 자동화 매크로`자세히 보자.
    
    # Codable 자동화 매크로란?
    
      
    Codable 자동화 매크로는 Swift 5.9부터 도입된 매크로 기능을 활용해, 구조체나 클래스가 Codable 프로토콜을 준수할 때 반복적으로 작성해야 하는 `init(from:)`, `encode(to:)`, 그리고 `CodingKeys` 열거형 등을 `자동으로 생성해주는 도구`입니다.
    
      
    이 매크로들은 복잡한 JSON 구조, 커스텀 키 매핑, 기본값, 무시할 프로퍼티, 변환 및 검증 등 다양한 요구사항을 간결하게 처리할 수 있게 해줍니다.
    
      
    
    ---
    
    ## 기본 사용법
    
      
    가장 기본적으로, 구조체나 클래스에 `@Codable`(혹은 비슷한 이름의 매크로)을 붙이면, 모든 저장 프로퍼티에 대해 Codable 구현이 자동 생성됩니다.
    
    ```Swift
    @Codable
    struct User {
        var id: String
        var name: String
        var age: Int
    }
    ```
    
    이렇게 하면 별도의 `CodingKeys`나 `init(from:)`, `encode(to:)` 구현 없이 Codable을 사용할 수 있습니다.
    
      
    
    ---
    
      
    
    ## 커스텀 키 매핑 및 중첩 경로
    
      
    API 응답이 중첩된 구조이거나, Swift 프로퍼티명과 JSON 키가 다를 때, 각 프로퍼티에 커스텀 경로를 지정할 수 있습니다.
    
    ```Swift
    @Codable
    struct Person {
        @CodingField("data", "id")
        var id: String
    
        @CodingField("data", "meta", "name")
        var name: String
    
        @CodingField("data", "meta", "age")
        var age: Int
    }
    ```
    
    이 예시에서 `id`는 `data.id`, `name`과 `age`는 `data.meta.name`, `data.meta.age` 경로로 매핑됩니다.
    
      
    
    ---
    
      
    
    ## 기본값 및 Optional 지원
    
    키가 없거나 디코딩에 실패할 때 사용할 기본값을 지정할 수 있습니다.
    
    ```Swift
    @Codable
    struct Person {
        @CodingField("data", "id")
        var id: String?
    
        @CodingField("data", "meta", "name")
        var name: String = ""
    
        @CodingField("data", "meta", "age", default: 18)
        let age: Int
    }
    ```
    
    Optional 타입은 키가 없으면 nil이 되고,  
    기본값이 있으면 해당 값이 사용됩니다
    
      
    
    ---
    
      
    
    ## 무시할 프로퍼티 지정
    
    인코딩/디코딩에서 제외할 프로퍼티는 `@CodingIgnore`로 표시할 수 있습니다.
    
    ```Swift
    @Codable
    struct Person {
        @CodingIgnore
        var privateNotes: String = ""
    }
    ```
    
    - 이 프로퍼티는 JSON 변환에 포함되지 않습니다.
    
      
    
    ---
    
      
    
    ## 변환 및 검증
    
    디코딩/인코딩 시 값 변환이나 검증이 필요할 때, 별도의 매크로로 지정할 수 있습니다.
    
    ```Swift
    @Codable
    struct Person {
        @CodingField("data", "id")
        @DecodeTransform(source: String.self, with: { UUID(uuidString: $0)! })
        @EncodeTransform(source: UUID.self, with: \.uuidString)
        var id: UUID
    
        @CodingField("data", "meta", "name")
        @CodingValidate(source: String.self, with: { !$0.isEmpty })
        var name: String
    }
    ```
    
    - 디코딩 시 문자열을 UUID로 변환하거나,
    - 값이 비어있지 않은지 검증하는 등의 로직을 자동으로 추가할 수 있습니다
    
      
    
    ---
    
      
    
    ## 고급 기능: OneOf, AllOf, Flattened Model
    
    일부 매크로 라이브러리(MetaCodable, MacroCodableKit 등)는 OpenAPI의 OneOf/AllOf 지원, 중첩 모델의 평탄화, 여러 Codable 타입의 조합 등 고급 기능도 제공합니다
    
      
    
    대표적인 라이브러리
    
    - MetaCodable: 커스텀 키 매핑, 중첩 경로, 기본값, 여러 타입 조합, 평탄화 등 다양한 기능 제공.
    - swift-codable-macro: 커스텀 경로, 기본값, 무시, 변환, 검증 등 실무에 필요한 기능을 폭넓게 지원.
    - MacroCodableKit: OpenAPI의 OneOf/AllOf, 커스텀 CodingKeys, zero-allocation 등 고급 기능 제공.
    
    장점 요약
    
    - 보일러플레이트 코드 제거: 반복적인 Codable 구현을 자동화
    - 복잡한 JSON 구조 대응: 중첩, 커스텀 키, 평탄화 등 다양한 매핑 지원
    - 유지보수성 향상: 코드가 간결해지고, 실수 가능성 감소
    - 컴파일 타임 검증: 잘못된 매핑, 중복 경로 등은 컴파일 타임에 에러로 확인 가능

  

etc..

- @PublicInit: 멤버와이즈 이니셜라이저 자동 생성
- @GenerateMock: 프로토콜 기반 Mock 객체 자동 생성
- @KeyPathIterable: 타입의 모든 keyPath 자동 생성

  

---

  

# **Swift 매크로 만드는 방법**

## **1. 매크로 패키지 생성**

1. Xcode에서 **File > New > Package** 선택
2. **Swift Macro** 템플릿 선택 후 이름 지정
3. 패키지 내부 구조:
    - `**[MacroName].swift**`: 매크로 시그니처 선언
    - `**[MacroName]Macro.swift**`: 매크로 실제 구현
    - `**main.swift**`: 매크로 테스트 코드
    - `**[MacroName]Tests.swift**`: 매크로 테스트[2](https://swiftylion.com/articles/swift-macros)

## **2. 매크로 시그니처 선언**

```Swift
@freestanding(expression)
public macro URL(_ stringLiteral: String) -> URL = \#externalMacro(module: "MyMacrosPlugin", type: "URLMacro")
```

- `**module**`과 `**type**`은 구현체가 들어있는 모듈과 타입 이름[1](https://www.avanderlee.com/swift/macros/)[2](https://swiftylion.com/articles/swift-macros)[5](https://www.hackingwithswift.com/swift/5.9/macros).

## **3. 매크로 구현**

```Swift
public struct URLMacro: ExpressionMacro {
    public static func expansion(
        of node: some FreestandingMacroExpansionSyntax,
        in context: some MacroExpansionContext
    ) throws -> ExprSyntax {
        // 구현: 입력된 문자열이 유효한 URL인지 검사, 아니면 컴파일 에러 발생
    }
}
```

- 역할에 따라 `**ExpressionMacro**`, `**DeclarationMacro**` 등 프로토콜을 채택[2](https://swiftylion.com/articles/swift-macros).

## **4. 매크로 사용**

- 앱 타겟에서 매크로를 import하고, 선언한 대로 사용

## **참고: 대표적인 오픈소스 Swift 매크로**

- [MacroKit](https://github.com/krzysztofzablocki/Swift-Macros): 다양한 유틸리티 매크로 모음
- [InitMacro](https://github.com/krzysztofzablocki/Swift-Macros): 이니셜라이저 자동 생성
- [MetaCodable](https://github.com/krzysztofzablocki/Swift-Macros): Codable 자동화[4](https://github.com/krzysztofzablocki/Swift-Macros)

## **요약**

- Swift 매크로는 컴파일 타임에 코드 생성/검증을 통해 반복 코드를 줄이고, 안전성을 높임
- Freestanding(`**#**`)과 Attached(`**@**`) 두 가지 방식이 있음
- Xcode에서 Swift Macro 패키지를 생성해 직접 구현 가능
- 다양한 오픈소스 매크로가 이미 존재하며, 직접 확장도 가능